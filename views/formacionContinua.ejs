<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bienvenido al sistema de inscripción</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <script src="https://unpkg.com/boxicons@2.1.4/dist/boxicons.js"></script>
  </head>
  <body>
    <div class="container mt-5">
      <center>
        <h1>Bienvenido al sistema de formación continua</h1>
      </center>
      <a href="/IES_9-024/materias" class="btn btn-primary mb-3">
        Ir a Materias/Talleres
      </a>
      <div class="row mb-3">
        <div class="col-md-4">
          <label for="filtroFacultad" class="form-label"><strong>Filtrar por Facultad:</strong></label>
          <select id="filtroFacultad" class="form-select">
            <option value="">Todas</option>
            <% facultades.forEach(f => { %>
              <option value="<%= f.idfacultad %>"><%= f.nombreFacultad %></option>
            <% }); %>
          </select>
        </div>
        <div class="col-md-4">
          <label for="filtroMateria" class="form-label"><strong>Filtrar por Materia:</strong></label>
          <select id="filtroMateria" class="form-select">
            <option value="">Todas</option>
            <% materias.forEach(m => { %>
              <option value="<%= m.idmateria %>" data-facultad="<%= m.facultad_idfacultad %>"><%= m.materia %></option>
            <% }); %>
          </select>
        </div>
        <div class="col-md-4">
          <label for="filtroHabilitado" class="form-label"><strong>Filtrar por estado:</strong></label>
          <select id="filtroHabilitado" class="form-select" style="max-width: 200px;">
            <option value="1">Habilitados</option>
            <option value="0">Deshabilitados</option>
            <option value="todos">Todos</option>
          </select>
        </div>
      </div>
      
      <div class="mb-3">
      <span class="badge bg-success fs-5">
        Inscriptos habilitados: <%= inscripcionesHabilitadas.length %>
      </span>
      <div class="mt-2">
        <% Object.keys(cantidadPorMateria).forEach(function(materia) { %>
          <span class="badge bg-info text-dark me-2">
            <%= materia %>: <%= cantidadPorMateria[materia] %>
          </span>
        <% }); %>
      </div>
    </div>
      <div class="table-responsive mt-4">
        <table class="table table-bordered table-striped">
          <thead class="table-dark">
            <tr>
              <th>N°</th>
              <th>ID Inscripción</th>
              <th>Fecha Inscripción</th>
              <th>Apellido y Nombre</th>
              <th>Fecha Final</th>
              <th>Detalle</th>
              <th>Habilitado</th>
              <th>ID Facultad</th>
              <th>ID Estado Alumno</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <% if (inscripciones && inscripciones.length > 0) { %>
              <% inscripciones.forEach(function(insc, i) { %>
                <tr data-habilitado="<%= insc.habilitado %>" data-facultad="<%= insc.facultad_idfacultad %>" data-materia="<%= insc.detalle && insc.detalle.idmateria ? insc.detalle.idmateria : '' %>">
                  <td><%= i + 1 %></td>
                  <td><%= insc.idinscripcion %></td>
                  <td><%= insc.fechaInscripcion 
                    ? new Date(insc.fechaInscripcion).toLocaleString('es-AR', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })
                    : '' %></td>
                  <td><%= (insc.apellido || '') + ' ' + (insc.nombre || '') %></td>
                  <td><%= insc.fechaFinal 
                    ? new Date(insc.fechaFinal).toLocaleString('es-AR', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })
                    : '' %></td>
                  <td><%= insc.materia %></td>
                  <td><%= insc.habilitado == 1 ? 'Sí' : 'No'%></td>
                  <td><%= insc.facultad %></td>
                  <td><%= insc.estadoAlumno %></td>
                  <td>
                    <% if (insc.habilitado == 1) { %>
                      <button class="btn btn-warning btn-sm deshabilitar-insc" data-id="<%= insc.idinscripcion %>">Deshabilitar</button>
                    <% } else { %>
                      <button class="btn btn-success btn-sm habilitar-insc" data-id="<%= insc.idinscripcion %>">Habilitar</button>
                    <% } %>
                  </td>
                </tr>
              <% }); %>
            <% } else { %>
              <tr>
                <td colspan="8" class="text-center">No hay inscripciones registradas.</td>
              </tr>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>
    <script>
      window.addEventListener('DOMContentLoaded', function() {
        document.getElementById('filtroHabilitado').value = '1';
        document.getElementById('filtroHabilitado').dispatchEvent(new Event('change'));
      });
      // Filtrado de materias según facultad seleccionada
      document.getElementById('filtroFacultad').addEventListener('change', function() {
        const idFacultad = this.value;
        // Oculta/filtra materias según facultad
        document.querySelectorAll('#filtroMateria option').forEach(opt => {
          if (!opt.value) {
            opt.style.display = '';
            opt.selected = true;
          } else if (!idFacultad || opt.getAttribute('data-facultad') === idFacultad) {
            opt.style.display = '';
          } else {
            opt.style.display = 'none';
          }
        });
        document.getElementById('filtroMateria').value = '';
        filtrarTabla();

        // Renumerar los números de orden después de filtrar
      let i = 1;
      document.querySelectorAll('tbody tr').forEach(function(tr) {
        if (tr.style.display !== 'none') {
          tr.querySelector('td').textContent = i++;
        }
      });
      });

      document.getElementById('filtroMateria').addEventListener('change', filtrarTabla);

      function filtrarTabla() {
        const idFacultad = document.getElementById('filtroFacultad').value;
        const idMateria = document.getElementById('filtroMateria').value;
        document.querySelectorAll('tbody tr').forEach(tr => {
          const fac = tr.getAttribute('data-facultad');
          const mat = tr.getAttribute('data-materia');
          let mostrar = true;
          if (idFacultad && fac !== idFacultad) mostrar = false;
          if (idMateria && mat !== idMateria) mostrar = false;
          tr.style.display = mostrar ? '' : 'none';
        });
        // Renumerar los números de orden después de filtrar
      let i = 1;
      document.querySelectorAll('tbody tr').forEach(function(tr) {
        if (tr.style.display !== 'none') {
          tr.querySelector('td').textContent = i++;
        }
      });
      }

      document.getElementById('filtroHabilitado').addEventListener('change', function() {
        const filtro = this.value;
        document.querySelectorAll('tbody tr').forEach(function(tr) {
          const habilitado = tr.getAttribute('data-habilitado');
          let mostrar = true;
          if (filtro === '1') mostrar = (habilitado === '1');
          else if (filtro === '0') mostrar = (habilitado === '0');
          tr.style.display = (filtro === 'todos' || mostrar) ? '' : 'none';
        });
         // Renumerar los números de orden después de filtrar
      let i = 1;
      document.querySelectorAll('tbody tr').forEach(function(tr) {
        if (tr.style.display !== 'none') {
          tr.querySelector('td').textContent = i++;
        }
      });
      });

      // Deshabilitar inscripción
      document.querySelectorAll('.deshabilitar-insc').forEach(function(btn) {
        btn.addEventListener('click', async function() {
          if (!confirm('¿Seguro que desea deshabilitar esta inscripción?')) return;
          const id = this.getAttribute('data-id');
          try {
            const res = await fetch('/IES_9-024/inscripcion/deshabilitar', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ idinscripcion: id })
            });
            const data = await res.json();
            if (res.ok && data.ok) {
              location.reload();
            } else {
              alert('No se pudo deshabilitar.');
            }
          } catch (e) {
            alert('Error de conexión.');
          }
        });
      });

      // Habilitar inscripción
      document.querySelectorAll('.habilitar-insc').forEach(function(btn) {
        btn.addEventListener('click', async function() {
          if (!confirm('¿Seguro que desea habilitar esta inscripción?')) return;
          const id = this.getAttribute('data-id');
          try {
            const res = await fetch('/IES_9-024/inscripcion/habilitar', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ idinscripcion: id })
            });
            const data = await res.json();
            if (res.ok && data.ok) {
              location.reload();
            } else {
              alert('No se pudo habilitar.');
            }
          } catch (e) {
            alert('Error de conexión.');
          }
        });
      });

      
    </script>
  </body>
</html>